import jax
jax.config.update("jax_enable_x64", True)
import jax.numpy as jnp
import numpy as np
from functools import partial
# from itertools import permutations

####################################################################################
def get_w0():
    # get frequency
    datastr = """
    1   1          1558.938300000000
    2   2           774.536950000000
    3   3           650.054050000000
    4   4           578.952950000000
    5   5           449.782050000000
    6   6          1598.280050000000
    7   7           588.022650000000
    8   8           526.115600000000
    9   9          1554.729200000000
    10  10           756.175000000000
    11  11           578.401200000000
    12  12           425.089850000000
    13  13          1605.632450000000
    14  14           587.496500000000
    15  15           407.757500000000
    """
    
    lines = datastr.strip().split('\n')
    data_array = np.array([list(map(float, line.split()[2:])) for line in lines])
    w0 = np.array(data_array[:, 0], dtype=np.float64) * 2
    return w0


def get_k30():
    ### get cubic force constants k30
    datastr = """
    1   1   1          -160.175425000000
    2   1   1            -6.718175000000
    2   2   1            75.552955000000
    2   2   2           -17.182263333333
    3   1   1           -12.256105000000
    3   2   1             0.149370000000
    3   2   2           -27.908630000000
    3   3   1            31.983365000000
    3   3   2           -55.130070000000
    3   3   3           -38.045533333333
    4   1   1            -2.843830000000
    4   2   1            11.174750000000
    4   2   2             7.402320000000
    4   3   1           103.264000000000
    4   3   2            -8.698580000000
    4   3   3            22.005730000000
    4   4   1           146.375340000000
    4   4   2           -53.709300000000
    4   4   3           -27.518990000000
    4   4   4            -2.653498333333
    5   1   1            11.496815000000
    5   2   1           -13.289830000000
    5   2   2             6.428145000000
    5   3   1             1.309790000000
    5   3   2            37.498270000000
    5   3   3            27.932045000000
    5   4   1            47.778100000000
    5   4   2            32.913620000000
    5   4   3            44.131660000000
    5   4   4           -22.307415000000
    5   5   1            14.602840000000
    5   5   2           -38.269705000000
    5   5   3           -82.582690000000
    5   5   4            37.699155000000
    5   5   5             3.142750000000
    6   6   1          -511.109175000000
    6   6   2            46.765755000000
    6   6   3           -14.127890000000
    6   6   4             3.825200000000
    6   6   5            10.644605000000
    7   6   1             7.003130000000
    7   6   2          -201.026220000000
    7   6   3           -18.824080000000
    7   6   4          -118.619520000000
    7   6   5           -12.642850000000
    7   7   1           112.279965000000
    7   7   2            28.114355000000
    7   7   3           -24.760815000000
    7   7   4            15.123595000000
    7   7   5            24.061955000000
    8   6   1             7.175720000000
    8   6   2           107.074310000000
    8   6   3          -117.262920000000
    8   6   4          -271.559470000000
    8   6   5           -57.824710000000
    8   7   1            -4.546500000000
    8   7   2           -17.281030000000
    8   7   4            -8.606550000000
    8   7   5            51.042750000000
    8   8   1           163.221730000000
    8   8   2            14.463960000000
    8   8   3           -25.610630000000
    8   8   4             3.072835000000
    8   8   5           -18.466600000000
    13  13   1          -505.726340000000
    13  13   2            45.782170000000
    13  13   3           -16.536040000000
    13  13   4             5.225805000000
    13  13   5            13.565450000000
    14  13   1            14.655620000000
    14  13   2           166.270830000000
    14  13   3           -83.788010000000
    14  13   4          -152.852480000000
    14  13   5           -39.005570000000
    14  14   1           116.785600000000
    14  14   2            18.064410000000
    14  14   3           -34.697475000000
    14  14   4             5.985670000000
    14  14   5           -30.082770000000
    15  13   1            43.670550000000
    15  13   2          -218.538010000000
    15  13   3           -65.952820000000
    15  13   4          -275.363900000000
    15  13   5           -57.355440000000
    15  14   1           -36.578430000000
    15  14   2           -27.279190000000
    15  14   3             6.528430000000
    15  14   4             3.078170000000
    15  14   5            12.354830000000
    15  15   1           233.151210000000
    15  15   2            33.932875000000
    15  15   3           -14.008975000000
    15  15   4            21.019335000000
    15  15   5            15.650585000000
    13   9   6         -1015.931920000000
    13   9   7            -0.572300000000
    13   9   8             7.399390000000
    14   9   6            17.485780000000
    14   9   7          -107.232320000000
    14   9   8           247.070400000000
    15   9   6            46.162080000000
    15   9   7           300.830650000000
    15   9   8           136.072210000000
    9   9   1          -482.033645000000
    9   9   2            -3.259065000000
    9   9   3           -10.892755000000
    9   9   4            -3.784785000000
    9   9   5            11.551495000000
    13  10   6          -101.125990000000
    13  10   7           192.988630000000
    13  10   8          -103.672690000000
    14  10   6          -166.150830000000
    14  10   7            40.542990000000
    14  10   8           -42.597240000000
    15  10   6           222.945620000000
    15  10   7           -62.902840000000
    15  10   8           -13.831370000000
    10   9   1            -1.252570000000
    10   9   2          -139.437930000000
    10   9   3            10.054810000000
    10   9   4           -13.429010000000
    10   9   5             7.870370000000
    10  10   1            68.963810000000
    10  10   2           -36.542665000000
    10  10   3            -3.136690000000
    10  10   4            -3.098440000000
    10  10   5            -4.238495000000
    13  11   6            -9.078040000000
    13  11   7           113.473380000000
    13  11   8           284.567790000000
    14  11   6           163.851070000000
    14  11   7           -15.665480000000
    14  11   8            39.594020000000
    15  11   6           279.488670000000
    15  11   7           -21.712630000000
    15  11   8           -16.929520000000
    11   9   1             3.313200000000
    11   9   2            -7.606140000000
    11   9   3          -102.927760000000
    11   9   4          -287.741390000000
    11   9   5           -53.278640000000
    11  10   1             8.066800000000
    11  10   2           -13.125790000000
    11  10   3           -16.621340000000
    11  10   4           -61.904570000000
    11  10   5            11.230000000000
    11  11   1           148.288805000000
    11  11   2           -34.833590000000
    11  11   3           -16.548925000000
    11  11   4           -14.120310000000
    11  11   5             3.257905000000
    13  12   6           -68.538050000000
    13  12   7             9.714270000000
    13  12   8          -117.443820000000
    14  12   6           -94.546230000000
    14  12   7           -18.994580000000
    14  12   8            66.823690000000
    15  12   6           -33.641580000000
    15  12   7             0.933190000000
    15  12   8            33.859470000000
    12   9   1           -46.723350000000
    12   9   2           -30.903910000000
    12   9   3            49.061090000000
    12   9   4            84.716730000000
    12   9   5            28.465550000000
    12  10   1            32.527890000000
    12  10   2           -23.835030000000
    12  10   3            15.885120000000
    12  10   4            23.665570000000
    12  10   5             8.082660000000
    12  11   1           -97.710170000000
    12  11   2            26.384270000000
    12  11   3           -41.638300000000
    12  11   4           -54.539010000000
    12  11   5           -35.610600000000
    12  12   1            12.540995000000
    12  12   2           -39.879140000000
    12  12   3           -60.209705000000
    12  12   4            85.727740000000
    12  12   5           -96.897900000000
    """
    
    k30 = np.zeros((15, 15, 15), dtype=np.float64)
    lines = datastr.strip().split('\n')
    for line in lines:
        i, j, k, value = map(float, line.split())
        indices = (int(i)-1, int(j)-1, int(k)-1)
        #weight = len(set(permutations(indices)))/6
        #k30[indices] = value * weight
        k30[indices] = value
    return k30


def get_k40():
    ### get quartic force constants k40
    datastr = """
    1   1   1   1            10.999066666667
    2   1   1   1             0.798651666667
    2   2   1   1           -24.764282500000
    2   2   2   1             2.705270000000
    2   2   2   2             1.250888333333
    3   1   1   1             0.795920000000
    3   2   1   1            11.006220000000
    3   2   2   1            -2.539430000000
    3   2   2   2             0.337816666667
    3   3   1   1            -5.908992500000
    3   3   2   1            -1.143595000000
    3   3   2   2             3.647557500000
    3   3   3   1            -1.230033333333
    3   3   3   2             3.567313333333
    3   3   3   3             1.927610416667
    4   1   1   1             0.424831666667
    4   2   1   1            -4.929370000000
    4   2   2   1             0.932370000000
    4   2   2   2             0.401203333333
    4   3   1   1           -24.998625000000
    4   3   2   2            -0.233270000000
    4   3   3   1            -1.119065000000
    4   3   3   2            -2.631455000000
    4   3   3   3            -0.183883333333
    4   4   1   1           -35.199177500000
    4   4   2   1             7.998890000000
    4   4   2   2             3.451672500000
    4   4   3   1            -1.259395000000
    4   4   3   2            -0.485890000000
    4   4   3   3             4.199012500000
    4   4   4   1             1.850263333333
    4   4   4   2            -0.597116666667
    4   4   4   3             3.393225000000
    4   4   4   4             3.622880416667
    5   1   1   1            -0.853143333333
    5   2   1   1             0.358650000000
    5   2   2   1             1.717475000000
    5   2   2   2            -0.236706666667
    5   3   1   1            -6.698210000000
    5   3   2   2            -2.947060000000
    5   3   3   1             2.749215000000
    5   3   3   2            -5.934870000000
    5   3   3   3            -2.912890000000
    5   4   1   1           -17.129920000000
    5   4   2   2            -0.147660000000
    5   4   3   3            -0.877455000000
    5   4   4   1             0.824150000000
    5   4   4   2             3.228740000000
    5   4   4   3             9.931690000000
    5   4   4   4             4.584618333333
    5   5   1   1            -1.734420000000
    5   5   2   1            -2.172395000000
    5   5   2   2             3.437712500000
    5   5   3   1            -1.722740000000
    5   5   3   2             8.468130000000
    5   5   3   3             8.084187500000
    5   5   4   1             1.020850000000
    5   5   4   2            -1.851490000000
    5   5   4   3            -5.779580000000
    5   5   4   4             2.381335000000
    5   5   5   1             0.207208333333
    5   5   5   2            -0.681495000000
    5   5   5   3            -1.515018333333
    5   5   5   4            -0.407746666667
    5   5   5   5             0.251671250000
    6   6   1   1            70.735397500000
    6   6   2   1            -9.459010000000
    6   6   2   2           -31.964137500000
    6   6   3   1             5.599680000000
    6   6   3   2            13.259260000000
    6   6   3   3            -7.258082500000
    6   6   4   1            -0.585740000000
    6   6   4   2            -6.218770000000
    6   6   4   3           -26.890535000000
    6   6   4   4           -38.532890000000
    6   6   5   1            -2.966255000000
    6   6   5   2             0.388105000000
    6   6   5   3            -6.714680000000
    6   6   5   4           -18.415465000000
    6   6   5   5            -2.628880000000
    6   6   6   6            12.480835416667
    7   6   1   1            -1.149270000000
    7   6   2   2            -5.496595000000
    7   6   3   3             1.336910000000
    7   6   4   4            -2.299465000000
    7   6   5   5             2.109495000000
    7   6   6   6             4.188470000000
    7   7   1   1           -30.286802500000
    7   7   2   1            -4.377010000000
    7   7   2   2             9.484357500000
    7   7   3   1             3.226250000000
    7   7   3   2            -2.859530000000
    7   7   3   3             0.182247500000
    7   7   4   1            -2.337635000000
    7   7   4   2             8.362510000000
    7   7   4   3             2.775255000000
    7   7   4   4             6.709200000000
    7   7   5   1            -2.873705000000
    7   7   5   2             1.544050000000
    7   7   5   3             1.965570000000
    7   7   5   4             3.980410000000
    7   7   5   5             0.177877500000
    7   7   6   6           -31.447552500000
    7   7   7   6             2.321256666667
    7   7   7   7             2.728082500000
    8   6   1   1            -0.765820000000
    8   6   2   2             4.051215000000
    8   6   3   3            -0.344770000000
    8   6   4   4            -0.596625000000
    8   6   5   5            -0.854010000000
    8   6   6   6            -2.277860000000
    8   7   1   1             0.057460000000
    8   7   2   2            -8.988660000000
    8   7   3   3            -0.288825000000
    8   7   4   4             8.767065000000
    8   7   5   5            -3.896600000000
    8   7   6   6             0.083195000000
    8   7   7   6            -0.709510000000
    8   7   7   7            -0.908128333333
    8   8   1   1           -41.194987500000
    8   8   2   1            -0.953795000000
    8   8   2   2             3.914407500000
    8   8   3   1             2.416255000000
    8   8   3   2            -5.238320000000
    8   8   3   3             3.880372500000
    8   8   4   1            -0.807100000000
    8   8   4   2           -11.015475000000
    8   8   4   3            16.599390000000
    8   8   4   4            18.371102500000
    8   8   5   1             2.513220000000
    8   8   5   2            -2.752295000000
    8   8   5   3             6.058395000000
    8   8   5   4             9.605425000000
    8   8   5   5            -1.001427500000
    8   8   6   6           -42.609082500000
    8   8   7   6             1.737980000000
    8   8   7   7             7.224122500000
    8   8   8   6            -0.379020000000
    8   8   8   7            -1.302585000000
    8   8   8   8             5.049138333333
    13  13   1   1            70.332600000000
    13  13   2   1            -8.832525000000
    13  13   2   2           -31.659582500000
    13  13   3   1             5.588525000000
    13  13   3   2            13.032905000000
    13  13   3   3            -6.953995000000
    13  13   4   1             0.587680000000
    13  13   4   2            -6.479340000000
    13  13   4   3           -26.941720000000
    13  13   4   4           -38.291097500000
    13  13   5   1            -2.595615000000
    13  13   5   2             0.373810000000
    13  13   5   3            -7.295180000000
    13  13   5   4           -18.623405000000
    13  13   5   5            -2.501612500000
    13  13   6   6            74.216285000000
    13  13   7   6            11.230615000000
    13  13   7   7           -31.078567500000
    13  13   8   6            -7.746990000000
    13  13   8   7            -0.373640000000
    13  13   8   8           -42.356707500000
    13  13  13  13            12.287187916667
    14  13   1   1            -1.769290000000
    14  13   2   2             6.130385000000
    14  13   3   3            -0.800465000000
    14  13   4   4             1.268660000000
    14  13   5   5            -1.233705000000
    14  13   6   6           -12.656160000000
    14  13   7   7            -2.307955000000
    14  13   8   8            -1.469375000000
    14  13  13  13            -4.334480000000
    14  14   1   1           -31.292925000000
    14  14   2   1            -1.200475000000
    14  14   2   2             7.208490000000
    14  14   3   1             2.419075000000
    14  14   3   2            -6.918625000000
    14  14   3   3             3.446357500000
    14  14   4   1            -1.451505000000
    14  14   4   2            -7.610465000000
    14  14   4   3             8.890550000000
    14  14   4   4             9.086440000000
    14  14   5   1             4.576170000000
    14  14   5   2            -3.406775000000
    14  14   5   3             4.078870000000
    14  14   5   4             5.658500000000
    14  14   5   5            -0.424062500000
    14  14   6   6           -32.365752500000
    14  14   7   6             1.900575000000
    14  14   7   7             7.788922500000
    14  14   8   6            -1.089765000000
    14  14   8   7           -13.444345000000
    14  14   8   8            20.504072500000
    14  14  13  13           -31.973740000000
    14  14  14  13            -0.487120000000
    14  14  14  14             3.046556666667
    15  13   1   1            -8.472215000000
    15  13   2   2            -4.920665000000
    15  13   3   3             0.669670000000
    15  13   4   4            -1.348765000000
    15  13   5   5             0.426510000000
    15  13   6   6             6.207485000000
    15  13   7   7             8.572900000000
    15  13   8   8             4.196120000000
    15  13  13  13             1.361575000000
    15  14   1   1             6.811435000000
    15  14   2   2           -17.907610000000
    15  14   3   3             0.077030000000
    15  14   4   4            11.151265000000
    15  14   5   5            -2.757715000000
    15  14   6   6             7.378395000000
    15  14   7   7           -14.448670000000
    15  14   8   8            10.313355000000
    15  14  13  13             6.939080000000
    15  14  14  13             3.322070000000
    15  14  14  14            -2.193670000000
    15  15   1   1           -53.565630000000
    15  15   2   1            -9.708015000000
    15  15   2   2            15.424445000000
    15  15   3   2             2.629525000000
    15  15   3   3             2.088802500000
    15  15   4   1            -8.528110000000
    15  15   4   2            27.908725000000
    15  15   4   3            12.017485000000
    15  15   4   4            27.749842500000
    15  15   5   1            -0.473335000000
    15  15   5   2             7.142005000000
    15  15   5   3             0.292090000000
    15  15   5   4            13.886125000000
    15  15   5   5             2.608182500000
    15  15   6   6           -56.054677500000
    15  15   7   6            11.816385000000
    15  15   7   7            27.141210000000
    15  15   8   6             4.291795000000
    15  15   8   7            15.267615000000
    15  15   8   8            17.227340000000
    15  15  13  13           -54.428125000000
    15  15  14  13            -0.531645000000
    15  15  14  14            10.897312500000
    15  15  15  13             4.930415000000
    15  15  15  14            -5.100671666667
    15  15  15  15            10.908403750000
    9   9   1   1            65.950400000000
    9   9   2   1             1.870960000000
    9   9   2   2           -24.881275000000
    9   9   3   1             2.651325000000
    9   9   3   2            10.540830000000
    9   9   3   3            -6.055920000000
    9   9   4   1             1.190150000000
    9   9   4   2            -4.866350000000
    9   9   4   3           -24.482665000000
    9   9   4   4           -35.018232500000
    9   9   5   1            -2.261160000000
    9   9   5   2             0.261165000000
    9   9   5   3            -6.405905000000
    9   9   5   4           -17.270250000000
    9   9   5   5            -2.194905000000
    9   9   6   6            70.822485000000
    9   9   7   6            -0.872035000000
    9   9   7   7           -30.133817500000
    9   9   8   6            -0.863370000000
    9   9   8   7             0.036635000000
    9   9   8   8           -41.288342500000
    13  13   9   9            70.222690000000
    14  13   9   9            -2.347450000000
    14  14   9   9           -31.241770000000
    15  13   9   9            -7.629165000000
    15  14   9   9             7.154040000000
    15  15   9   9           -53.103090000000
    9   9   9   9            11.005129583333
    10   9   1   1            -1.143180000000
    10   9   2   2            -9.093440000000
    10   9   3   3            -0.337275000000
    10   9   4   4            -7.778050000000
    10   9   5   5             0.546430000000
    10   9   6   6            11.413585000000
    10   9   7   7             5.069750000000
    10   9   8   8             2.159055000000
    13  13  10   9            10.775485000000
    14  14  10   9             1.981060000000
    15  15  10   9             9.479875000000
    10   9   9   9            -0.153505000000
    10  10   1   1           -26.182777500000
    10  10   2   1             9.191450000000
    10  10   2   2             5.741717500000
    10  10   3   1            -1.091545000000
    10  10   3   2            -1.640490000000
    10  10   3   3             0.478320000000
    10  10   4   1             0.812890000000
    10  10   4   2             0.676535000000
    10  10   4   3             1.910835000000
    10  10   4   4             2.558897500000
    10  10   5   1             1.280340000000
    10  10   5   2            -1.087105000000
    10  10   5   3             1.048365000000
    10  10   5   4             0.835700000000
    10  10   5   5             0.708630000000
    10  10   6   6           -33.451360000000
    10  10   7   6            -5.845050000000
    10  10   7   7            10.510107500000
    10  10   8   6             4.182715000000
    10  10   8   7            -9.815700000000
    10  10   8   8             4.412355000000
    13  13  10  10           -33.009222500000
    14  13  10  10             6.196350000000
    14  14  10  10             7.490970000000
    15  13  10  10            -5.578190000000
    15  14  10  10           -17.675305000000
    15  15  10  10            14.241595000000
    10  10   9   9           -25.866320000000
    10  10  10   9            -3.015808333333
    10  10  10  10             1.004524583333
    11   9   1   1            -0.959455000000
    11   9   2   2            -1.238805000000
    11   9   3   3             0.524390000000
    11   9   4   4            -1.806635000000
    11   9   5   5            -0.475160000000
    11   9   6   6             0.042895000000
    11   9   7   7             2.047045000000
    11   9   8   8            -1.805465000000
    13  13  11   9            -1.203940000000
    14  14  11   9            -2.049910000000
    15  15  11   9             7.511345000000
    11   9   9   9            -0.370668333333
    11  10   1   1            -1.656205000000
    11  10   2   2             0.972130000000
    11  10   3   3            -1.506255000000
    11  10   4   4             0.087070000000
    11  10   5   5             0.422690000000
    11  10   6   6            -2.473675000000
    11  10   7   7             7.934880000000
    11  10   8   8           -12.628615000000
    13  13  11  10            -2.247515000000
    14  14  11  10           -10.771655000000
    15  15  11  10            24.942445000000
    11  10   9   9            -1.552310000000
    11  10  10   9            -1.242905000000
    11  10  10  10             0.087320000000
    11  11   1   1           -38.232672500000
    11  11   2   1             6.992580000000
    11  11   2   2             2.720150000000
    11  11   3   1            -0.551480000000
    11  11   3   2            -1.882120000000
    11  11   3   3             3.385247500000
    11  11   4   1             1.264125000000
    11  11   4   3            18.236055000000
    11  11   4   4            23.426585000000
    11  11   5   1             1.117125000000
    11  11   5   3             5.460335000000
    11  11   5   4            14.067455000000
    11  11   6   6           -42.177800000000
    11  11   7   7             7.993975000000
    11  11   8   6            -1.318295000000
    11  11   8   7            10.658915000000
    11  11   8   8            23.712432500000
    13  13  11  11           -41.333295000000
    14  13  11  11            -0.559400000000
    14  14  11  11            11.652237500000
    15  13  11  11             0.323625000000
    15  14  11  11            13.537635000000
    15  15  11  11            25.067120000000
    11  11   9   9           -37.869740000000
    11  11  10   9            -6.184245000000
    11  11  10  10             3.807822500000
    11  11  11   9            -0.473886666667
    11  11  11  10             0.014875000000
    11  11  11  11             4.643085833333
    12   9   1   1             5.220655000000
    12   9   2   2            -4.180845000000
    12   9   3   3            -2.176905000000
    12   9   4   4            -5.188600000000
    12   9   5   5            -0.250455000000
    12   9   6   6             7.039280000000
    12   9   7   7            -2.956835000000
    12   9   8   8            -7.945165000000
    13  13  12   9             7.248890000000
    14  14  12   9            -6.268520000000
    15  15  12   9            -6.661120000000
    12   9   9   9             1.835690000000
    12  10   1   1            -7.851170000000
    12  10   2   2             2.433800000000
    12  10   3   3             0.641395000000
    12  10   4   4             0.762850000000
    12  10   5   5             0.984820000000
    12  10   6   6            -9.904200000000
    12  10   7   7             1.652655000000
    12  10   8   8             5.159945000000
    13  13  12  10            -9.814100000000
    14  14  12  10             5.265440000000
    15  15  12  10            -0.747145000000
    12  10   9   9            -7.839685000000
    12  10  10   9            -4.770540000000
    12  10  10  10             1.036671666667
    12  11   1   1            21.082475000000
    12  11   2   2            -2.225545000000
    12  11   3   3            -0.126105000000
    12  11   4   4           -15.074805000000
    12  11   5   5             1.131765000000
    12  11   6   6            23.128840000000
    12  11   7   7            -2.875380000000
    12  11   8   8           -16.274845000000
    13  13  12  11            22.495875000000
    14  14  12  11            -7.097305000000
    15  15  12  11            -9.793420000000
    12  11   9   9            20.708710000000
    12  11  10  10            -3.073775000000
    12  11  11   9            -6.939515000000
    12  11  11  10             0.130015000000
    12  11  11  11            -5.018403333333
    12  12   1   1            -3.930602500000
    12  12   2   1             2.006290000000
    12  12   2   2             0.936735000000
    12  12   3   1            -0.581450000000
    12  12   3   2             2.469635000000
    12  12   3   3             3.735525000000
    12  12   4   1            -1.808845000000
    12  12   4   2            -7.952835000000
    12  12   4   3            -8.663855000000
    12  12   4   4             7.686317500000
    12  12   5   1            -2.542800000000
    12  12   5   2            11.985555000000
    12  12   5   3            18.693170000000
    12  12   5   4           -14.038800000000
    12  12   5   5             7.609765000000
    12  12   6   6            -4.592362500000
    12  12   7   6             1.345360000000
    12  12   7   7            -0.078572500000
    12  12   8   6             4.315930000000
    12  12   8   7            -2.823040000000
    12  12   8   8             3.023072500000
    13  13  12  12            -4.409237500000
    14  13  12  12             2.721545000000
    14  14  12  12             2.240912500000
    15  13  12  12             2.501240000000
    15  14  12  12             0.194310000000
    15  15  12  12            -1.473950000000
    12  12   9   9            -3.666782500000
    12  12  10   9            -1.396920000000
    12  12  10  10             0.624052500000
    12  12  11   9             2.411415000000
    12  12  11  10            -1.846695000000
    12  12  11  11             0.994810000000
    12  12  12   9            -0.256161666667
    12  12  12  10             1.396725000000
    12  12  12  11             0.650556666667
    12  12  12  12             2.045118750000
    """
    
    k40 = np.zeros((15, 15, 15, 15), dtype=np.float64)
    lines = datastr.strip().split('\n')
    for line in lines:
        i, j, k, l, value = map(float, line.split())
        indices = (int(i)-1, int(j)-1, int(k)-1, int(l)-1)
        #weight = len(set(permutations(indices)))/24
        #k40[indices] = value * weight
        k40[indices] = value
    return k40

####################################################################################
def get_potential_energy_C2H4O(alpha=1000):
    """
        Get potential energy function for C2H4O (Ethylene oxide).
        Ref: A comparison of two methods for selecting vibrational configuration 
            interaction spaces on a heptatomic system: Ethylene oxide
    """

    w0 = get_w0()
    print("w0, harmonic constants:", np.count_nonzero(w0))
    w = w0 / alpha
    sqrtw = np.sqrt(w)
    
    k2 = (1/2) * jnp.diag(w**2)
    
    k30 = get_k30()
    print("k30, non-zero terms:", np.count_nonzero(k30))
    k3 = jnp.einsum('ijk,i,j,k->ijk', k30, sqrtw, sqrtw, sqrtw) / alpha

    k40 = get_k40()
    print("k40, non-zero terms:", np.count_nonzero(k40))
    k4 = jnp.einsum('ijkl,i,j,k,l->ijkl', k40, sqrtw, sqrtw, sqrtw, sqrtw) / alpha

    #==== get potential energy ====
    @partial(jax.jit)
    @partial(jax.vmap, in_axes=0, out_axes=0)
    def potential_energy(x):
        q = x[:, 0]
        V =  (1/2) * jnp.einsum('i,i->', w**2, q**2) \
           + jnp.einsum('ijk,i,j,k->', k3, q, q, q) \
           + jnp.einsum('ijkl,i,j,k,l->', k4, q, q, q, q)
           
        return V

    return potential_energy, jnp.array(w, dtype=jnp.float64), \
        jnp.array(k2, dtype=jnp.float64), jnp.array(k3, dtype=jnp.float64), jnp.array(k4, dtype=jnp.float64)

####################################################################################
# test
if __name__ == "__main__":
    #==== test for potential ====
    print("\n==== test potential ====")
    batch, n, dim = 10, 15, 1
    key = jax.random.PRNGKey(42)
    x = jax.random.normal(key, (batch, n, dim))
    
    alpha = 1000
    potential_energy, w_indices = get_potential_energy_C2H4O(alpha=alpha)
    print("w:", w_indices)
    print("w^2:", w_indices**2)
    print("x.shape:", x.shape)
    print("V(x):", potential_energy(x))
    
    import orbitals
    num_orb = 170
    orb_index, orb_state, orb_Es = orbitals.get_orbitals_indices_first(w_indices, max_orb=1000, num_orb = num_orb)
    orb_Es = orb_Es * alpha
    print("Total number of orbitals:", num_orb)
    print("Energy of non-interacting system:")
    for ii in range(num_orb): 
        print("    %d, E: %.3f, orbital:" %(ii, orb_Es[ii]), orbitals.orbitals_array2str(orb_state[ii]))
    
    choose_orb = [0, 138, 11, 9, 6, 3, 163, 8, 4, 136, 10, 5, 2, 168, 7, 1, 70, 129, 126, 128, 123, 130, 133]
    orb_index, orb_state, orb_Es = orbitals.choose_orbitals(orb_state, orb_Es, choose_orb)
    num_orb = len(choose_orb)
    print("Total number of orbitals:", num_orb)
    print("Energy of non-interacting system:(choose states!)")
    for ii in range(num_orb): 
        print("    %d, E: %.3f, orbital:" %(ii, orb_Es[ii]), orbitals.orbitals_array2str(orb_state[ii]))    
    